<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kaggle Bitcoin History data processor | MBIO blog</title>
    <meta name="description" content="mbio 개발 관련 블로그">
    <link rel="icon" href="/blog/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons">
    
    <link rel="preload" href="/blog/assets/css/0.styles.26bc8f1a.css" as="style"><link rel="preload" href="/blog/assets/js/app.8add82b3.js" as="script"><link rel="preload" href="/blog/assets/js/14.15ace990.js" as="script"><link rel="preload" href="/blog/assets/js/2.4b6c6e93.js" as="script"><link rel="preload" href="/blog/assets/js/10.55108ca9.js" as="script"><link rel="prefetch" href="/blog/assets/js/11.07ba04d9.js"><link rel="prefetch" href="/blog/assets/js/12.be094342.js"><link rel="prefetch" href="/blog/assets/js/13.71897b3c.js"><link rel="prefetch" href="/blog/assets/js/15.f3610778.js"><link rel="prefetch" href="/blog/assets/js/16.b4dd7ed1.js"><link rel="prefetch" href="/blog/assets/js/17.cf2936c5.js"><link rel="prefetch" href="/blog/assets/js/18.8590cdd4.js"><link rel="prefetch" href="/blog/assets/js/19.317a955f.js"><link rel="prefetch" href="/blog/assets/js/20.f5b09281.js"><link rel="prefetch" href="/blog/assets/js/21.4fe122f4.js"><link rel="prefetch" href="/blog/assets/js/22.be05eb0d.js"><link rel="prefetch" href="/blog/assets/js/23.1762001e.js"><link rel="prefetch" href="/blog/assets/js/24.faffedbc.js"><link rel="prefetch" href="/blog/assets/js/25.303cdf6b.js"><link rel="prefetch" href="/blog/assets/js/26.fc63930a.js"><link rel="prefetch" href="/blog/assets/js/27.e27c22bc.js"><link rel="prefetch" href="/blog/assets/js/3.e9476580.js"><link rel="prefetch" href="/blog/assets/js/4.1cbc055f.js"><link rel="prefetch" href="/blog/assets/js/5.38fdf9bc.js"><link rel="prefetch" href="/blog/assets/js/6.c9cc0705.js"><link rel="prefetch" href="/blog/assets/js/7.90ba73ee.js"><link rel="prefetch" href="/blog/assets/js/8.28a92a6c.js"><link rel="prefetch" href="/blog/assets/js/9.f068bed2.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.26bc8f1a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">MBIO blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/intro.html" class="nav-link">Intro</a></div><div class="nav-item"><a href="https://github.com/qnwlqnwlxm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/intro.html" class="nav-link">Intro</a></div><div class="nav-item"><a href="https://github.com/qnwlqnwlxm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/intro.html" class="sidebar-link">intro</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/ApacheNiFi/" class="sidebar-heading clickable router-link-active open"><span>Apaceh NiFi</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog/ApacheNiFi/Processor/" class="sidebar-heading clickable router-link-active open"><span>NiFi Custom Processor</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/ApacheNiFi/Processor/make-project.html" class="sidebar-link">프로젝트 생성</a></li><li><a href="/blog/ApacheNiFi/Processor/kaggle-bitcoin-1.html" class="sidebar-link">kaggle-bitcoin-1</a></li><li><a href="/blog/ApacheNiFi/Processor/kaggle-bitcoin-2.html" class="sidebar-link">kaggle-bitcoin-2</a></li><li><a href="/blog/ApacheNiFi/Processor/kaggle-bitcoin-3.html" class="active sidebar-link">kaggle-bitcoin-3</a></li><li><a href="/blog/ApacheNiFi/Processor/kaggle-bitcoin-4.html" class="sidebar-link">kaggle-bitcoin-4</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog/ApacheNiFi/ControllerService/" class="sidebar-heading clickable"><span>NiFi Custom ControllerService</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/Book/" class="sidebar-heading clickable"><span>Book Summary</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/blog/Spring/" class="sidebar-link">Spring</a></li><li><a href="/blog/Tech/" class="sidebar-link">Tech</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kaggle-bitcoin-history-data-processor"><a href="#kaggle-bitcoin-history-data-processor" aria-hidden="true" class="header-anchor">#</a> Kaggle Bitcoin History data processor</h1> <h2 id="bitcoinhistoryprocessor-3"><a href="#bitcoinhistoryprocessor-3" aria-hidden="true" class="header-anchor">#</a> BitcoinHistoryProcessor - 3</h2> <h3 id="processor-source-구조"><a href="#processor-source-구조" aria-hidden="true" class="header-anchor">#</a> processor source 구조</h3> <p>기본적으로 mvn archetype을 이용해 프로세서를 생성하면 아래와 같은 형태로 processor가 생성됩니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Tags</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@CapabilityDescription</span><span class="token punctuation">(</span><span class="token string">&quot;Provide a description&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SeeAlso</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ReadsAttributes</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token annotation punctuation">@ReadsAttribute</span><span class="token punctuation">(</span>attribute<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@WritesAttributes</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token annotation punctuation">@WritesAttribute</span><span class="token punctuation">(</span>attribute<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BitcoinHistory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProcessor</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">PropertyDescriptor</span> MY_PROPERTY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PropertyDescriptor</span>
            <span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;MY_PROPERTY&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token string">&quot;My property&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">&quot;Example Property&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addValidator</span><span class="token punctuation">(</span><span class="token class-name">StandardValidators</span><span class="token punctuation">.</span>NON_EMPTY_VALIDATOR<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Relationship</span> MY_RELATIONSHIP <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Relationship</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;MY_RELATIONSHIP&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">&quot;Example relationship&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span> descriptors<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span> relationships<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessorInitializationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span> descriptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        descriptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>MY_PROPERTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>descriptors <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>descriptors<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span> relationships <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        relationships<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>MY_RELATIONSHIP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>relationships <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableSet</span><span class="token punctuation">(</span>relationships<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRelationships</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>relationships<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSupportedPropertyDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> descriptors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OnScheduled</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onScheduled</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessContext</span> context<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ProcessSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProcessException</span> <span class="token punctuation">{</span>
        <span class="token class-name">FlowFile</span> flowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> flowFile <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO implement</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>class에 여러 annotation이 정의되어있는것을 볼 수 있습니다.<br>
nifi는 다양한 annotation을 제공하여 개발 편의성이 높습니다.<br>
processor의 input을 강제할수도 있고, ReadsAttributes 와 WritesAttributes 어노테이션을 작성하면 view usage에서 자동으로 프로세서의 참고 문서를 작성해줍니다.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>모든 프로세서는 AbstractProcessor를 상속받아서 동작합니다.
AbstractProcessor에서 정의한 init, getRelationships, getSupportedPropertyDescriptors, onTrigger등을 override하여 thread 핸들링에 대한 큰 고민없이 편하게 개발할 수 있습니다.</p></div> <p>getRelationships 을 통해 processor relation을 정의하고,<br>
getSupportedPropertyDescriptors을 통해 property를 정의합니다.</p> <p>init method는 nifi에서 processor가 생성될때 단 한번만 호출되어, 초기화 메소드를 작성하기에 좋습니다.</p> <p>@OnScheduled annotation이 붙은 onScheduled 메소드는 프로세서를 시작할때 한번 호출됩니다.</p> <p>onTrigger method는 processor가 실행될때마다 호출되는 메소드 입니다.<br>
nifi는 프로세서의 실행 시간을 사용자가 ui로 지정할 수 있어, 해당 실행시점마다 호출되는 메소드입니다.</p> <p>이외에도 프로세스 정지 시점에 호출되는 메소드 등 lifecycle마다 동작을 정의할 수 있습니다.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>추가로 nifi에서는 Concurrent Tasks옵션을 통해 실행 시점마다 몇개의 thread를 사용하여 실행할 것인지 지정할 수 있습니다.<br>
이 때문에 onTrigger 메소드는 동시에 여러개의 thread가 호출 할수 있기 때문에 항상 thread safe하게 코딩해야합니다.</p></div> <h3 id="relation-property-정의"><a href="#relation-property-정의" aria-hidden="true" class="header-anchor">#</a> relation &amp; property 정의</h3> <p>이제 본격적으로 processor를 만들기 위해 processor의 relation과 property를 정의합니다.</p> <p>input으로 들어온 flowfile을 처리하고 성공 실패시 flowfile을 어느쪽으로 보낼지, processor의 동작을 어떻게 처리할 지에 대한 property를 정의하는 것입니다.</p> <p>위의 소스 구조에서 relation과 property를 작성하면 소스가 너무 길어지기 때문에 이부분은 별도 class로 구분하여 작성하겠습니다.</p> <p>아래와 같이 ConfigUtil enum class를 작성합니다.</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ConfigUtil</span> <span class="token punctuation">{</span>

  INSTANCE<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span> properties<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span> relationships<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> JSON_RECORDS <span class="token operator">=</span> <span class="token string">&quot;JSON records created&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> XML_RECORDS <span class="token operator">=</span> <span class="token string">&quot;XML records created&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> RECORDS_READ <span class="token operator">=</span> <span class="token string">&quot;CSV records read&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> JSON_MIME_TYPE <span class="token operator">=</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> XML_MIME_TYPE <span class="token operator">=</span> <span class="token string">&quot;text/xml&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">PropertyDescriptor</span> OUTPUT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PropertyDescriptor</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;output&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token string">&quot;Output format&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">&quot;Format of output FlowFiles&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">allowableValues</span><span class="token punctuation">(</span><span class="token string">&quot;XML&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;JSON&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ALL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token string">&quot;ALL&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">addValidator</span><span class="token punctuation">(</span><span class="token class-name">StandardValidators</span><span class="token punctuation">.</span>NON_EMPTY_VALIDATOR<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Relationship</span> XML <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Relationship</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">&quot;Files process as JSON successfully routed here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Relationship</span> JSON <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Relationship</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">&quot;Files process as XML successfully routed here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Relationship</span> FAILURE <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Relationship</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;failure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">&quot;Files routed here after processing failure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    properties<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span> relationships <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    relationships<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    relationships<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>XML<span class="token punctuation">)</span><span class="token punctuation">;</span>
    relationships<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>relationships <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableSet</span><span class="token punctuation">(</span>relationships<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> properties<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRelaltionships</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> relationships<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>

</code></pre></div><p>relation으로 xml과 json 그리고 실패시 flowfile을 이동시키기위한 failure를 정의합니다.
property로는 xml,json 혹은 둘다 어떤 포맷으로 변경할 것인지를 선택하기위한 옵션을 정의해줍니다.</p> <p>relation과 property를 정의했으니 이제 BitcoinHistory에서 정의해줍니다.<br>
아래처럼 당장 사용하지 않을 annotation을 제거하고, Input이 반드시 필요하기 때문에 @InputRequirement 어노테이션을 추가로 정의합니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Tags</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;Bitcoin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;JSON&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;XML&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CSV&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@CapabilityDescription</span><span class="token punctuation">(</span><span class="token string">&quot;Process Bitcoin transactions into XML or JSON format or both&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@InputRequirement</span><span class="token punctuation">(</span><span class="token class-name">Requirement</span><span class="token punctuation">.</span>INPUT_REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BitcoinHistory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProcessor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRelationships</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span><span class="token function">getRelaltionships</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSupportedPropertyDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OnScheduled</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onScheduled</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessContext</span> context<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ProcessSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProcessException</span> <span class="token punctuation">{</span>
        <span class="token class-name">FlowFile</span> flowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> flowFile <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO implement</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="flowfile의-conent를-읽어서-객체화하고-xml과-json으로-변환하여-내보내기"><a href="#flowfile의-conent를-읽어서-객체화하고-xml과-json으로-변환하여-내보내기" aria-hidden="true" class="header-anchor">#</a> flowfile의 conent를 읽어서 객체화하고 xml과 json으로 변환하여 내보내기</h3> <p>이제 실제 로직부분을 작성합니다.</p> <p>아래와 같이 BitcoinHistory를 작성합니다.</p> <details><summary>BitcoinHistory</summary> <p></p><div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">BufferedReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">BufferedWriter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">InputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">InputStreamReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">OutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">OutputStreamWriter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time</span><span class="token punctuation">.</span><span class="token class-name">Instant</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time</span><span class="token punctuation">.</span><span class="token class-name">ZoneId</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time</span><span class="token punctuation">.</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Set</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic</span><span class="token punctuation">.</span><span class="token class-name">AtomicBoolean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic</span><span class="token punctuation">.</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic</span><span class="token punctuation">.</span><span class="token class-name">AtomicReference</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind</span><span class="token punctuation">.</span><span class="token class-name">JAXBContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind</span><span class="token punctuation">.</span><span class="token class-name">JAXBException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind</span><span class="token punctuation">.</span><span class="token class-name">Marshaller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind</span><span class="token punctuation">.</span><span class="token class-name">ObjectMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind</span><span class="token punctuation">.</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>datatype<span class="token punctuation">.</span>jsr310</span><span class="token punctuation">.</span><span class="token class-name">JavaTimeModule</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mbio<span class="token punctuation">.</span>custom<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>model</span><span class="token punctuation">.</span><span class="token class-name">BitcoinHistoryModel</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>csv</span><span class="token punctuation">.</span><span class="token class-name">CSVFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>csv</span><span class="token punctuation">.</span><span class="token class-name">CSVRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>behavior</span><span class="token punctuation">.</span><span class="token class-name">InputRequirement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>behavior</span><span class="token punctuation">.</span><span class="token class-name">InputRequirement</span><span class="token punctuation">.</span><span class="token class-name">Requirement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>documentation</span><span class="token punctuation">.</span><span class="token class-name">CapabilityDescription</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>documentation</span><span class="token punctuation">.</span><span class="token class-name">Tags</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>lifecycle</span><span class="token punctuation">.</span><span class="token class-name">OnScheduled</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>components</span><span class="token punctuation">.</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>flowfile</span><span class="token punctuation">.</span><span class="token class-name">FlowFile</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>flowfile<span class="token punctuation">.</span>attributes</span><span class="token punctuation">.</span><span class="token class-name">CoreAttributes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>processor</span><span class="token punctuation">.</span><span class="token class-name">AbstractProcessor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>processor</span><span class="token punctuation">.</span><span class="token class-name">ProcessContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>processor</span><span class="token punctuation">.</span><span class="token class-name">ProcessSession</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>processor</span><span class="token punctuation">.</span><span class="token class-name">Relationship</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>exception</span><span class="token punctuation">.</span><span class="token class-name">ProcessException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">InputStreamCallback</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">OutputStreamCallback</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Tags</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;Bitcoin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;JSON&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;XML&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CSV&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@CapabilityDescription</span><span class="token punctuation">(</span><span class="token string">&quot;Process Bitcoin transactions into XML or JSON format or both&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@InputRequirement</span><span class="token punctuation">(</span><span class="token class-name">Requirement</span><span class="token punctuation">.</span>INPUT_REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BitcoinHistory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProcessor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">Output</span> <span class="token punctuation">{</span>
        ALL<span class="token punctuation">,</span> JSON<span class="token punctuation">,</span> XML<span class="token punctuation">,</span> DB
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JAXBContext</span><span class="token punctuation">&gt;</span></span> jaxb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Output</span><span class="token punctuation">&gt;</span></span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRelationships</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span><span class="token function">getRelaltionships</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertyDescriptor</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSupportedPropertyDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OnScheduled</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onScheduled</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> output <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>OUTPUT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Output</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapper<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JavaTimeModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapper<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span>WRITE_DATES_AS_TIMESTAMPS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span>INDENT_OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jaxb<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">JAXBContext</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">BitcoinHistoryModel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Could not create JAXB context&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessContext</span> context<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ProcessSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProcessException</span> <span class="token punctuation">{</span>
        <span class="token class-name">FlowFile</span> flowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flowFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> jsonCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> xmlCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> recordsCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BitcoinHistoryModel</span><span class="token punctuation">&gt;</span></span> jsonRecords <span class="token operator">=</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">.</span><span class="token function">newKeySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BitcoinHistoryModel</span><span class="token punctuation">&gt;</span></span> xmlRecords <span class="token operator">=</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">.</span><span class="token function">newKeySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> success <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        session<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>flowFile<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token keyword">final</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CSVRecord</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> <span class="token class-name">CSVFormat</span><span class="token punctuation">.</span>RFC4180<span class="token punctuation">.</span><span class="token function">withFirstRecordAsHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">CSVRecord</span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        recordsCounter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValid</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">final</span> <span class="token class-name">BitcoinHistoryModel</span> history <span class="token operator">=</span> <span class="token function">createModel</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOutputJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                jsonRecords<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                
                            <span class="token punctuation">}</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOutputXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                xmlRecords<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error Processing input&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    success<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOutputJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">writeJson</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> flowFile<span class="token punctuation">,</span> jsonRecords<span class="token punctuation">,</span> jsonCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOutputXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">writeXml</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> flowFile<span class="token punctuation">,</span> xmlRecords<span class="token punctuation">,</span> xmlCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        session<span class="token punctuation">.</span><span class="token function">adjustCounter</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>RECORDS_READ<span class="token punctuation">,</span> recordsCounter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">adjustCounter</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>JSON_RECORDS<span class="token punctuation">,</span> jsonCounter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">adjustCounter</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>XML_RECORDS<span class="token punctuation">,</span> xmlCounter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            session<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>flowFile<span class="token punctuation">,</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            session<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>flowFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeJson</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessSession</span> session<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">FlowFile</span> flowFile<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BitcoinHistoryModel</span><span class="token punctuation">&gt;</span></span> jsonRecords<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BitcoinHistoryModel</span> history <span class="token operator">:</span> jsonRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">FlowFile</span> createdFlowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>flowFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token class-name">FlowFile</span> jsonFlowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>createdFlowFile<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OutputStreamCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">OutputStream</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BufferedWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mapper<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> history<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Colud not write record to JSON: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token function">getFilename</span><span class="token punctuation">(</span>jsonFlowFile<span class="token punctuation">)</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">;</span>
            attrs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CoreAttributes</span><span class="token punctuation">.</span>FILENAME<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            attrs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CoreAttributes</span><span class="token punctuation">.</span>MIME_TYPE<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>JSON_MIME_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            attrs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>JSON_RECORDS<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token class-name">FlowFile</span> updatedFlowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">putAllAttributes</span><span class="token punctuation">(</span>jsonFlowFile<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            session<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>updatedFlowFile<span class="token punctuation">,</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Wrote {} to JSON&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeXml</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessSession</span> session<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">FlowFile</span> flowFile<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BitcoinHistoryModel</span><span class="token punctuation">&gt;</span></span> xmlRecords<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BitcoinHistoryModel</span> history <span class="token operator">:</span> xmlRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">FlowFile</span> createdFlowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>flowFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Marshaller</span> marshaller<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                marshaller <span class="token operator">=</span> jaxb<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createMarshaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                marshaller<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Marshaller</span><span class="token punctuation">.</span>JAXB_FORMATTED_OUTPUT<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">FlowFile</span> xmlFlowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>createdFlowFile<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OutputStreamCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">OutputStream</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BufferedWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            marshaller<span class="token punctuation">.</span><span class="token function">marshal</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Colud not write record to XML: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token function">getFilename</span><span class="token punctuation">(</span>xmlFlowFile<span class="token punctuation">)</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.xml&quot;</span><span class="token punctuation">;</span>
                attrs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CoreAttributes</span><span class="token punctuation">.</span>FILENAME<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                attrs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CoreAttributes</span><span class="token punctuation">.</span>MIME_TYPE<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>XML_MIME_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                attrs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>XML_RECORDS<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token class-name">FlowFile</span> updatedFlowFile <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">putAllAttributes</span><span class="token punctuation">(</span>xmlFlowFile<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>

                session<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>updatedFlowFile<span class="token punctuation">,</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>XML<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Wrote {} to XML&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JAXBException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;JAXBException&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                session<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>flowFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">BitcoinHistoryModel</span> <span class="token function">createModel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">CSVRecord</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">BitcoinHistoryModel</span> history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BitcoinHistoryModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> unixTimestamp <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Instant</span> instant <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">ofEpochSecond</span><span class="token punctuation">(</span>unixTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ZonedDateTime</span> timestamp <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">ofInstant</span><span class="token punctuation">(</span>instant<span class="token punctuation">,</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">double</span> high <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;High&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">double</span> low <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Low&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">double</span> close <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Close&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">double</span> btcVolume <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Volume_(BTC)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">double</span> usdVolume <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Volume_(Currency)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">double</span> weightedPrice <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Weighted_Price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        history<span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        history<span class="token punctuation">.</span><span class="token function">setOpen</span><span class="token punctuation">(</span><span class="token keyword">open</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        history<span class="token punctuation">.</span><span class="token function">setHigh</span><span class="token punctuation">(</span>high<span class="token punctuation">)</span><span class="token punctuation">;</span>
        history<span class="token punctuation">.</span><span class="token function">setLow</span><span class="token punctuation">(</span>low<span class="token punctuation">)</span><span class="token punctuation">;</span>
        history<span class="token punctuation">.</span><span class="token function">setClose</span><span class="token punctuation">(</span>close<span class="token punctuation">)</span><span class="token punctuation">;</span>
        history<span class="token punctuation">.</span><span class="token function">setBtcVolume</span><span class="token punctuation">(</span>btcVolume<span class="token punctuation">)</span><span class="token punctuation">;</span>
        history<span class="token punctuation">.</span><span class="token function">setUsdVolume</span><span class="token punctuation">(</span>usdVolume<span class="token punctuation">)</span><span class="token punctuation">;</span>
        history<span class="token punctuation">.</span><span class="token function">setWeightedPrice</span><span class="token punctuation">(</span>weightedPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> history<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">FlowFile</span> flowFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> fileName <span class="token operator">=</span> flowFile<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">CoreAttributes</span><span class="token punctuation">.</span>FILENAME<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">CSVRecord</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>record<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;NaN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isOutputJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> output<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Output</span><span class="token punctuation">.</span>ALL <span class="token operator">||</span> output<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Output</span><span class="token punctuation">.</span>JSON<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isOutputXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> output<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Output</span><span class="token punctuation">.</span>ALL <span class="token operator">||</span> output<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Output</span><span class="token punctuation">.</span>XML<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p></p></details> <h3 id="junit-test-작성"><a href="#junit-test-작성" aria-hidden="true" class="header-anchor">#</a> Junit test 작성</h3> <p>NiFi는 작성한 Custom Processor를 테스트하기 위한 Junit용 testRunner도 제공합니다.<br>
실제 배포 전에 동일한 환경에서 테스트를 할 수 있도록 cluster모드, thread safe 테스트를 위한 concurrent task 설정을 통한 테스트를 할 수 있습니다.</p> <p>실제로 작성한 코드가 정상 동작하는지 아래처럼 JUnit 코드를 작성합니다.</p> <details><summary>BitcoinHistoryTest</summary> <p></p><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file</span><span class="token punctuation">.</span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file</span><span class="token punctuation">.</span><span class="token class-name">Paths</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">TestRunner</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>nifi<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">TestRunners</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit</span><span class="token punctuation">.</span><span class="token class-name">Before</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit</span><span class="token punctuation">.</span><span class="token class-name">Test</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BitcoinHistoryTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TEST_FILE <span class="token operator">=</span> <span class="token string">&quot;test.csv&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> BAD_TEST_FILE <span class="token operator">=</span> <span class="token string">&quot;bad.csv&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">TestRunner</span> testRunner<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Path</span> input<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Path</span> badInput<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        testRunner <span class="token operator">=</span> <span class="token class-name">TestRunners</span><span class="token punctuation">.</span><span class="token function">newTestRunner</span><span class="token punctuation">(</span><span class="token class-name">BitcoinHistory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        input <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResource</span><span class="token punctuation">(</span>TEST_FILE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        badInput <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResource</span><span class="token punctuation">(</span>BAD_TEST_FILE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testRunner<span class="token punctuation">.</span><span class="token function">setClustered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAllOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>OUTPUT<span class="token punctuation">,</span> <span class="token string">&quot;ALL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">assertQueueEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>JSON<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>XML<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>FAILURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testJsonOnlyOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>OUTPUT<span class="token punctuation">,</span> <span class="token string">&quot;JSON&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">assertQueueEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>JSON<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>XML<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>FAILURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testXmlOnlyOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>OUTPUT<span class="token punctuation">,</span> <span class="token string">&quot;XML&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">assertQueueEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>JSON<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>XML<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>FAILURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBadOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>badInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">setClustered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>OUTPUT<span class="token punctuation">,</span> <span class="token string">&quot;XML&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">assertQueueEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>JSON<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>XML<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      testRunner<span class="token punctuation">.</span><span class="token function">assertTransferCount</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span>FAILURE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      testRunner<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p></p></details> <p>아래처럼 Junit테스트가 성공하면 정상적으로 로직을 작성한 것입니다.</p> <p><img src="/blog/assets/img/BitcoinHistoryTest.a5390a38.png" alt="BitcoinHistoryTest"></p> <p>NiFi에 배포 후에 테스트를 해보면 아래 와같이 3개의 프로세서로 csv파일을 xml과 json형태로 포맷변환을 해낸것을 확인할 수 있습니다.</p> <p><img src="/blog/assets/img/BitcoinHistoryDeploy.4f387251.png" alt="BitcoinHistoryDeploy"> <img src="/blog/assets/img/BitcoinHistory-json.056ce1ab.png" alt="BitcoinHistory-json"> <img src="/blog/assets/img/BitcoinHistory-xml.ae176a13.png" alt="BitcoinHistory-xml"></p> <p>변경사항은 아래에서 확인할 수 있습니다.</p> <p><a href="https://github.com/qnwlqnwlxm/BitcoinHistoryProcessor/pull/4/files" target="_blank" rel="noopener noreferrer">https://github.com/qnwlqnwlxm/BitcoinHistoryProcessor/pull/4/files<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>전체소스는 아래 에서 다운로드 가능합니다.
<a href="https://github.com/qnwlqnwlxm/BitcoinHistoryProcessor/tree/kaggle-bitcoin-3" target="_blank" rel="noopener noreferrer">https://github.com/qnwlqnwlxm/BitcoinHistoryProcessor/tree/kaggle-bitcoin-3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/ApacheNiFi/Processor/kaggle-bitcoin-2.html" class="prev">Kaggle Bitcoin History data processor</a></span> <span class="next"><a href="/blog/ApacheNiFi/Processor/kaggle-bitcoin-4.html">Kaggle Bitcoin History data processor</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.8add82b3.js" defer></script><script src="/blog/assets/js/14.15ace990.js" defer></script><script src="/blog/assets/js/2.4b6c6e93.js" defer></script><script src="/blog/assets/js/10.55108ca9.js" defer></script>
  </body>
</html>
